/*!
 * Knockout Siteengine
 * @version v0.1
 * @link https://github.com/low-res/ko-siteengine
 * @author we.byte GmbH - http://www.webyte.org
 */

define("router",["knockout","crossroads","hasher","signals"],function(e,t,n,r){function s(){{var t=this;this.currentRoute=e.observable({})}this.initalHash=null,this.currentHash=null,this.routes=[],this.routeChanged=new r.Signal,this.currentRouteIdx=e.computed(function(){var e=t.routes.indexOf(t.currentRoute());return e})}var a=s.prototype;return a.setRoutes=function(e){this.routes=e,this._initRoutes(),this._activateCrossroads(),n.setHash(this.routes[0].url)},a.gotoRoute=function(e){var t=this.findRoute(e.id);t?n.setHash(t.url):console.wran("the given route is not registerd! ",e)},a.gotoPage=function(e){n.setHash(this.routes[e].url)},a.nextPage=function(){n.setHash(this._getNextPageHash())},a.prevPage=function(){n.setHash(this._getPrevPageHash())},a.findRoute=function(t){var n=function(t,r){var s=null;return e.utils.arrayForEach(t,function(e){e.id==r||e.url==r?s=e:e.children&&null==s&&(s=n(e.children,r))}),s};return n(this.routes,t)},a.rootLine=function(){for(var e=[this.currentRoute()],t=this.currentRoute().parent;t;){var n=this.findRoute(t.id);e.push(n),t=n.parent}return e},a._getNextPageHash=function(){var e=this.routes.indexOf(this.currentRoute()),t=this.routes[e];return this.routes.length>e+1&&(t=this.routes[e+1]),t.url},a._getPrevPageHash=function(){var e=this.routes.indexOf(this.currentRoute()),t=this.routes[e];return e>0&&(t=this.routes[e-1]),t.url},a._initRoutes=function(){var n=this;t.removeAllRoutes();var r=function(s,a){e.utils.arrayForEach(s,function(s){s.parent=a,t.addRoute(s.url,function(t){var r=e.utils.extend(t,s.params);n.currentRoute(s),n.routeChanged.dispatch(r,s.url)}),s.children&&r(s.children,s)})};r(this.routes,null)},a._activateCrossroads=function(){function e(e,n){s.currentHash=e,t.parse(e)}function r(e,n){s.initalHash=e,t.parse(e)}var s=this;t.normalizeFn=t.NORM_AS_OBJECT,n.initialized.add(r),n.changed.add(e),n.init()},new s}),define("preloader",["amplify","jquery","preloadjs"],function(e,t){var n=function(t){switch(t.type){case"fileload":e.publish("preloader.fileload");break;case"error":e.publish("preloader.error");break;case"progress":e.publish("preloader.progress",{percentLoaded:100*t.progress})}};return{preloadAssetsManifest:function(r){e.publish("preloader.start");var s=t.Deferred(),a=new createjs.LoadQueue(!0);return a.on("fileload",n,this),a.on("fileprogress",n,this),a.on("error",n,this),a.on("progress",n,this),a.on("complete",function(){s.resolve(a),e.publish("preloader.complete",{assets:a})}),a.loadManifest(r),s.promise()}}}),define("defaultPageTransitionStrategy",["knockout","jquery","velocity","preloader"],function(e,t,n,r){function s(e){this.pageComponentDefinition=e,this.currentPageVmInstance=null,this.componentNameNewPage=null,this.newPageVmInstance=null,this.newPageVmParams=null,this.newPageUrl="",this.pageViewModels={}}var a=s.prototype;return a.handlePageChange=function(t,n,r){var s=this,a=t.page;this.newPageUrl=n,this.newPageVmParams=r,this.pageViewModels[n]?(this.newPageVmInstance=this.pageViewModels[n],this.componentNameNewPage=a,this._doPageTransition()):e.components.isRegistered(a)?s._processPageChange(a):s._dummyTransition(a)},a._processPageChange=function(t){var n=this;e.components.get(t,function(e){if(e.createViewModel){var r=e.createViewModel({});n.newPageVmInstance=r,n.componentNameNewPage=t,n.pageViewModels[n.newPageUrl]=r,n._doPageTransition()}else n._dummyTransition(t)})},a._doPageTransition=function(){this.hideAnimation().then(t.proxy(this.appendNewPage,this)).then(t.proxy(this.preloadAssets,this)).then(t.proxy(this.applyLoadedAssets,this)).then(t.proxy(this.showAnimation,this))},a.hideAnimation=function(){var e=this.currentPageVmInstance,n=t.Deferred().resolve().promise();return e&&e.hideAnimation&&(n=e.hideAnimation()),n},a.appendNewPage=function(){var e=this._generatePageSettings(this.componentNameNewPage,this.newPageVmInstance);this.currentPageVmInstance=this.newPageVmInstance,this.newPageVmInstance=null,this.pageComponentDefinition(e);var n=t.Deferred();return setTimeout(function(){n.resolve()},100),n.promise()},a.preloadAssets=function(){var e=this.currentPageVmInstance;return e.getPreloadAssetsManifest&&e.getPreloadAssetsManifest().length>0?r.preloadAssetsManifest(e.getPreloadAssetsManifest()):t.Deferred().resolve().promise()},a.applyLoadedAssets=function(e){var n=t.Deferred().resolve().promise(),r=this.currentPageVmInstance;return r.applyLoadedAssets&&(n=r.applyLoadedAssets(e)),n},a.showAnimation=function(){var e=t.Deferred().resolve().promise(),n=this.currentPageVmInstance;return n.showAnimation&&(e=n.showAnimation()),e},a._dummyTransition=function(e){var t=this._generatePageSettings(e);this.pageComponentDefinition(t)},a._generatePageSettings=function(e,t){var n={};return n.name=e,n.params=this.newPageVmParams?this.newPageVmParams:{},t&&(n.params.instance=t),n},s}),define("pageManager",["knockout","router","defaultPageTransitionStrategy"],function(e,t,n){function r(){this.route=t.currentRoute,this.routeIdx=t.currentRouteIdx,this.currentPage=e.observable({}),this.pageTransition=new n(this.currentPage),this.newPageParams=null,t.routeChanged.add(this.handlePageChange,this)}var s=r.prototype;return s.init=function(e){t.setRoutes(e)},s.changePageTo=function(e,n){this.newPageParams=n;var r=t.findRoute(e);t.gotoRoute(r)},s.handlePageChange=function(e,t){this.pageTransition.handlePageChange(e,t,this.newPageParams)},r}),require(["pageManager"]),require.config({bundles:{}});