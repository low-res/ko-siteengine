/*!
 * Knockout Siteengine
 * @version v0.1
 * @link https://github.com/low-res/ko-siteengine
 * @author we.byte GmbH - http://www.webyte.org
 */

define("router",["knockout","crossroads","hasher","signals"],function(e,t,n,r){function s(){{var t=this;this.currentRoute=e.observable({})}this.initalHash=null,this.currentHash=null,this.routes=[],this.routeChanged=new r.Signal,this.currentRouteIdx=e.computed(function(){var e=t.routes.indexOf(t.currentRoute());return e})}var i=s.prototype;return i.setRoutes=function(e){this.routes=e,this._initRoutes(),this._activateCrossroads(),n.setHash(this.routes[0].url)},i.gotoRoute=function(e){var t=this.findRoute(e.id);t?n.setHash(t.url):console.wran("the given route is not registerd! ",e)},i.gotoPage=function(e){n.setHash(this.routes[e].url)},i.nextPage=function(){n.setHash(this._getNextPageHash())},i.prevPage=function(){n.setHash(this._getPrevPageHash())},i.findRoute=function(t){var n=function(t,r){var s=null;return e.utils.arrayForEach(t,function(e){e.id==r||e.url==r?s=e:e.children&&null==s&&(s=n(e.children,r))}),s};return n(this.routes,t)},i.rootLine=function(){for(var e=[this.currentRoute()],t=this.currentRoute().parent;t;){var n=this.findRoute(t.id);e.push(n),t=n.parent}return e},i._getNextPageHash=function(){var e=this.routes.indexOf(this.currentRoute()),t=this.routes[e];return this.routes.length>e+1&&(t=this.routes[e+1]),t.url},i._getPrevPageHash=function(){var e=this.routes.indexOf(this.currentRoute()),t=this.routes[e];return e>0&&(t=this.routes[e-1]),t.url},i._initRoutes=function(){var n=this;t.removeAllRoutes();var r=function(s,i){e.utils.arrayForEach(s,function(s){s.parent=i,t.addRoute(s.url,function(t){var r=e.utils.extend(t,s.params);n.currentRoute(s),n.routeChanged.dispatch(r,s.url)}),s.children&&r(s.children,s)})};r(this.routes,null)},i._activateCrossroads=function(){function e(e,n){s.currentHash=e,t.parse(e)}function r(e,n){s.initalHash=e,t.parse(e)}var s=this;t.normalizeFn=t.NORM_AS_OBJECT,n.initialized.add(r),n.changed.add(e),n.init()},new s}),define("preloader",["amplify","jquery","preloadjs"],function(e,t){var n=function(t){switch(t.type){case"fileload":e.publish("preloader.fileload");break;case"error":e.publish("preloader.error");break;case"progress":e.publish("preloader.progress",{percentLoaded:100*t.progress})}};return{preloadAssetsManifest:function(r){e.publish("preloader.start");var s=t.Deferred(),i=new createjs.LoadQueue(!0);return i.on("fileload",n,this),i.on("fileprogress",n,this),i.on("error",n,this),i.on("progress",n,this),i.on("complete",function(){s.resolve(i),e.publish("preloader.complete",{assets:i})}),i.loadManifest(r),s.promise()}}}),define("pagetransition",["knockout","jquery","velocity","preloader"],function(e,t,n,r){function s(e){this.pageComponentDefinition=e,this.currentPageVmInstance=null,this.componentNameNewPage=null,this.newPageVmInstance=null,this.newPageVmParams=null,this.newPageUrl="",this.pageViewModels={}}var i=s.prototype;return i.handlePageChange=function(t,n,r){var s=this,i=t.page;this.newPageUrl=n,this.newPageVmParams=r,this.pageViewModels[n]?(this.newPageVmInstance=this.pageViewModels[n],this.componentNameNewPage=i,this._doPageTransition()):e.components.isRegistered(i)?s._processPageChange(i):s._dummyTransition(i)},i._processPageChange=function(t){var n=this;e.components.get(t,function(e){if(e.createViewModel){var r=e.createViewModel({});n.newPageVmInstance=r,n.componentNameNewPage=t,n.pageViewModels[n.newPageUrl]=r,n._doPageTransition()}else n._dummyTransition(t)})},i._doPageTransition=function(){this.hideAnimation().then(t.proxy(this.appendNewPage,this)).then(t.proxy(this.preloadAssets,this)).then(t.proxy(this.applyLoadedAssets,this)).then(t.proxy(this.showAnimation,this))},i.hideAnimation=function(){var e=this.currentPageVmInstance,n=t.Deferred().resolve().promise();return e&&e.hideAnimation&&(n=e.hideAnimation()),n},i.appendNewPage=function(){var e=this._generatePageSettings(this.componentNameNewPage,this.newPageVmInstance);this.currentPageVmInstance=this.newPageVmInstance,this.newPageVmInstance=null,this.pageComponentDefinition(e);var n=t.Deferred();return setTimeout(function(){n.resolve()},100),n.promise()},i.preloadAssets=function(){var e=this.currentPageVmInstance;return e.getPreloadAssetsManifest&&e.getPreloadAssetsManifest().length>0?r.preloadAssetsManifest(e.getPreloadAssetsManifest()):t.Deferred().resolve().promise()},i.applyLoadedAssets=function(e){var n=t.Deferred().resolve().promise(),r=this.currentPageVmInstance;return r.applyLoadedAssets&&(n=r.applyLoadedAssets(e)),n},i.showAnimation=function(){var e=t.Deferred().resolve().promise(),n=this.currentPageVmInstance;return n.showAnimation&&(e=n.showAnimation()),e},i._dummyTransition=function(e){var t=this._generatePageSettings(e);this.pageComponentDefinition(t)},i._generatePageSettings=function(e,t){var n={};return n.name=e,n.params=this.newPageVmParams?this.newPageVmParams:{},t&&(n.params.instance=t),n},s}),define("pageManager",["knockout","router","pagetransition"],function(e,t,n){function r(){this.route=t.currentRoute,this.routeIdx=t.currentRouteIdx,this.currentPage=e.observable({}),this.pageTransition=new n(this.currentPage),this.newPageParams=null,t.routeChanged.add(this.handlePageChange,this)}var s=r.prototype;return s.init=function(e){t.setRoutes(e)},s.changePageTo=function(e,n){this.newPageParams=n;var r=t.findRoute(e);t.gotoRoute(r)},s.handlePageChange=function(e,t){this.pageTransition.handlePageChange(e,t,this.newPageParams)},s.setPageTransitionObject=function(e){this.pageTransition=e},r}),require(["pageManager"]),require.config({bundles:{}});